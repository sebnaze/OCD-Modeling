<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OCD_modeling.mcmc.history_analysis &mdash; OCD modeling  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            OCD modeling
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamical_analysis.html">Dynamical system analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization.html">Simulation-based inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../restoration.html">Restoration analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../validation.html">Digital twins validation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OCD modeling</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">OCD_modeling.mcmc.history_analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for OCD_modeling.mcmc.history_analysis</h1><div class="highlight"><pre>
<span></span><span class="c1">### Analyze history of optimizations</span>
<span class="c1">##  Author: Sebastien Naze</span>
<span class="c1">#   QIMR 2023</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> 
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pingouin</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">import</span> <span class="nn">pyabc</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sbn</span>
<span class="kn">import</span> <span class="nn">sklearn</span>

<span class="kn">import</span> <span class="nn">OCD_modeling</span>
<span class="c1"># import most relevant environment and project variable</span>
<span class="kn">from</span> <span class="nn">OCD_modeling.utils</span> <span class="kn">import</span> <span class="n">cohen_d</span><span class="p">,</span> <span class="n">get_working_dir</span><span class="p">,</span> <span class="n">today</span>

<span class="n">working_dir</span> <span class="o">=</span> <span class="n">get_working_dir</span><span class="p">()</span>
<span class="n">proj_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="s1">&#39;lab_lucac/sebastiN/projects/OCD_modeling&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="import_results">
<a class="viewcode-back" href="../../../api/OCD_modeling.mcmc.html#OCD_modeling.import_results">[docs]</a>
<span class="k">def</span> <span class="nf">import_results</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Read optimization results from DB &quot;&quot;&quot;</span> 
    <span class="n">histories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">db_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">histories</span><span class="p">):</span>
        <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;traces&#39;</span><span class="p">,</span> <span class="n">db_name</span><span class="o">+</span><span class="s1">&#39;.db&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">history_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">histories</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyabc</span><span class="o">.</span><span class="n">History</span><span class="p">(</span><span class="s2">&quot;sqlite:///&quot;</span><span class="o">+</span><span class="n">db_path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimization </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s1"> does not exist, check name.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">histories</span></div>

    

<span class="k">def</span> <span class="nf">load_empirical_FC</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Loads functional connectivity from patients and controls (data, not simulation) &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;postprocessing&#39;</span><span class="p">,</span> <span class="s1">&#39;df_roi_corr_avg_2023.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_data</span>       


<span class="k">def</span> <span class="nf">get_ax_inds</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">row_offset</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; create list of axes to iterate from when plotting &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrows</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncols</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">col_ind</span><span class="o">&lt;</span><span class="n">col_offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row_ind</span><span class="o">&lt;</span><span class="n">row_offset</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span><span class="p">)</span>


<div class="viewcode-block" id="plot_epsilons">
<a class="viewcode-back" href="../../../optimization.html#OCD_modeling.plot_epsilons">[docs]</a>
<span class="k">def</span> <span class="nf">plot_epsilons</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Plot evolution of epsilons across generations </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        histories: list</span>
<span class="sd">            Optimization pyABC history objects (e.g. controls and patients)</span>
<span class="sd">        ax: matplotlib.Axes</span>
<span class="sd">            (optional) Axis to draw the figure.</span>
<span class="sd">        args: argparse.Namespace</span>
<span class="sd">            (optional) Extra arguments (for saving, etc).</span>

<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">n_hist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">histories</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">history</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;controls&#39;</span><span class="p">:</span>
            <span class="n">pyabc</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">plot_epsilons</span><span class="p">([</span><span class="n">history</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>



<div class="viewcode-block" id="plot_weights">
<a class="viewcode-back" href="../../../optimization.html#OCD_modeling.plot_weights">[docs]</a>
<span class="k">def</span> <span class="nf">plot_weights</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Plot evolution of weights across generations</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        histories: list</span>
<span class="sd">            Optimization pyABC history objects (e.g. controls and patients)</span>
<span class="sd">        gs: matplotlib.GridSpec</span>
<span class="sd">            (optional) GridSpec object to draw the figure into.</span>
<span class="sd">        nrows, ncols: int</span>
<span class="sd">            number of rows/columns to make the grid.</span>
<span class="sd">        row_offset, col_offset: int</span>
<span class="sd">            offsets to account for when some (top left) entries of the grid should be left empty.</span>
<span class="sd">        args: argparse.Namespace</span>
<span class="sd">            (optional) Extra arguments (e.g. for saving, etc).</span>

<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">n_hist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">histories</span><span class="p">)</span>
    <span class="n">n_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">max_t</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">histories</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    
    <span class="k">if</span> <span class="n">gs</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span> <span class="n">row_offset</span><span class="p">,</span> <span class="n">col_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
        
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">history</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ax_inds</span> <span class="o">=</span> <span class="n">get_ax_inds</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">row_offset</span><span class="o">=</span><span class="n">row_offset</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">col_offset</span><span class="p">)</span>
        <span class="c1">#for j in np.arange(history.max_t+1):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ax_inds</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
            <span class="n">df</span><span class="p">,</span><span class="n">w</span>  <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)),</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="c1">#if x==nrows-1:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;particle&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">y</span><span class="o">==</span><span class="n">col_offset</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="n">row_offset</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\omega$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="c1">#plt.legend(args.history_names)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1">#xtl = ax.get_xticklabels()</span>
            <span class="c1">#ax.set_xticklabels(xtl, fontsize=12)</span>
            <span class="c1">#ytl = ax.get_yticklabels()</span>
            <span class="c1">#ax.set_yticklabels(ytl, fontsize=12)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_param_distrib">
<a class="viewcode-back" href="../../../api/OCD_modeling.mcmc.html#OCD_modeling.plot_param_distrib">[docs]</a>
<span class="k">def</span> <span class="nf">plot_param_distrib</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; plot posterior distribution at end of optimization &quot;&quot;&quot;</span>
    <span class="n">n_hist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">histories</span><span class="p">)</span>
    <span class="n">n_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">max_t</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">histories</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># xlims </span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">history</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">max_t</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">df</span><span class="p">,</span><span class="n">w</span>  <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">n_gen</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n_cols</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="n">n_cols</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

                <span class="c1"># use first generation (prior) to set xlims</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">xs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">plot_kde_matrix</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">history</span><span class="p">)</span> <span class="ow">in</span> <span class="n">histories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pyabc</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">plot_kde_matrix</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>


<div class="viewcode-block" id="compute_stats">
<a class="viewcode-back" href="../../../optimization.html#OCD_modeling.compute_stats">[docs]</a>
<span class="k">def</span> <span class="nf">compute_stats</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Computes the statistics of the optimization outcome, i.e. tests the posterior distributions (parameters) </span>
<span class="sd">    between controls and patients.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">        histories: list</span>
<span class="sd">            Controls and patient pyABC history objects. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        df_stats: pandas DataFrame </span>
<span class="sd">            Statistics.  </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_post_con</span><span class="p">,</span><span class="n">w_con</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">df_post_pat</span><span class="p">,</span><span class="n">w_pat</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df_post_con</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">mc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">df_post_con</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">df_post_pat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        
        <span class="n">stat_norm_con</span><span class="p">,</span><span class="n">p_norm_con</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">normaltest</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">stat_norm_pat</span><span class="p">,</span><span class="n">p_norm_pat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">normaltest</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="n">t</span><span class="p">,</span><span class="n">p_t</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    
        <span class="n">u</span><span class="p">,</span><span class="n">p_u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        
        <span class="n">h</span><span class="p">,</span><span class="n">p_h</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">kruskal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">OCD_modeling</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cohen_d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="n">ks_res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">ks_2samp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:15}</span><span class="s2">    t=</span><span class="si">{:8.2f}</span><span class="s2">    p=</span><span class="si">{:.4f}</span><span class="s2">    p_bf=</span><span class="si">{:.4f}</span><span class="s2">    normality(con/pat)=</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">    </span><span class="se">\</span>
<span class="s2">                U=</span><span class="si">{:8d}</span><span class="s2">    p=</span><span class="si">{:.4f}</span><span class="s2">    p_bf=</span><span class="si">{:.4f}</span><span class="s2">    H=</span><span class="si">{:8.3f}</span><span class="s2">    p=</span><span class="si">{:.4f}</span><span class="s2">    p_bf=</span><span class="si">{:.4f}</span><span class="s2">    </span><span class="se">\</span>
<span class="s2">                d=</span><span class="si">{:.4f}</span><span class="s2">    ks=</span><span class="si">{:.2f}</span><span class="s2">    p_ks=</span><span class="si">{:.4f}</span><span class="s2">    p_bf=</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">col</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p_t</span><span class="p">,</span><span class="n">p_t</span><span class="o">*</span><span class="n">mc</span><span class="p">,</span><span class="n">p_norm_con</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">,</span><span class="n">p_norm_pat</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="n">p_u</span><span class="p">,</span> <span class="n">p_u</span><span class="o">*</span><span class="n">mc</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">p_h</span><span class="p">,</span><span class="n">p_h</span><span class="o">*</span><span class="n">mc</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">ks_res</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="n">ks_res</span><span class="o">.</span><span class="n">pvalue</span><span class="p">,</span> <span class="n">ks_res</span><span class="o">.</span><span class="n">pvalue</span><span class="o">*</span><span class="n">mc</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
        <span class="n">df_line</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;param&#39;</span><span class="p">:</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;p_t&#39;</span><span class="p">:</span><span class="n">p_t</span><span class="p">,</span> <span class="s1">&#39;p_t_bf&#39;</span><span class="p">:</span><span class="n">p_t</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="s1">&#39;normality&#39;</span><span class="p">:(</span><span class="n">p_norm_con</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_norm_pat</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">),</span> \
                <span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;p_u&#39;</span><span class="p">:</span><span class="n">p_u</span><span class="p">,</span> <span class="s1">&#39;p_u_bf&#39;</span><span class="p">:</span><span class="n">p_u</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> \
                <span class="s1">&#39;h&#39;</span><span class="p">:</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;p_h&#39;</span><span class="p">:</span><span class="n">p_h</span><span class="p">,</span> <span class="s1">&#39;p_h_bf&#39;</span><span class="p">:</span><span class="n">p_h</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;ks&#39;</span><span class="p">:</span><span class="n">ks_res</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="s1">&#39;p_ks&#39;</span><span class="p">:</span><span class="n">ks_res</span><span class="o">.</span><span class="n">pvalue</span><span class="p">}</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_line</span><span class="p">)</span>
    <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_stats</span></div>



<div class="viewcode-block" id="compute_kdes">
<a class="viewcode-back" href="../../../optimization.html#OCD_modeling.compute_kdes">[docs]</a>
<span class="k">def</span> <span class="nf">compute_kdes</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">n_pts</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Computes Kernel Density Estimates (KDEs) of the posterior distributions of parameters.</span>
<span class="sd">    </span>
<span class="sd">    :param histories: (dict) nested dictionnary of SQL alchemy history objects.</span>
<span class="sd">    :param n_pts: (int) number of points used to estimate the probability density functions (PDFs).</span>

<span class="sd">    :returns kdes: (dict) nested dictiorany of KDEs and associated PDFs.</span>
<span class="sd">    :returns cols: (list) list of parameters for which the KDEs were estimated.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kdes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cohort</span><span class="p">,</span><span class="n">history</span> <span class="ow">in</span> <span class="n">histories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">kdes</span><span class="p">[</span><span class="n">cohort</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">df</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
            <span class="n">kde</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">neighbors</span><span class="o">.</span><span class="n">KernelDensity</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="n">bw</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">bw</span><span class="p">,</span> <span class="n">vmax</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">bw</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">kdes</span><span class="p">[</span><span class="n">cohort</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kde&#39;</span><span class="p">:</span><span class="n">kde</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span><span class="n">pdf</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;vals&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]}</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_kdes</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;postprocessing&#39;</span><span class="p">,</span> <span class="s1">&#39;kdes_&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">histories</span><span class="p">)</span><span class="o">+</span><span class="n">today</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">kdes</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kdes</span><span class="p">,</span> <span class="n">cols</span></div>


<span class="k">def</span> <span class="nf">custom_plot_epsilons</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_gens</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">,</span> <span class="s1">&#39;OCD&#39;</span><span class="p">]</span><span class="c1">#list(histories.keys())</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">history</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># extract epsilons</span>
        <span class="c1"># note: first entry is from calibration and thus translates to inf,</span>
        <span class="c1"># thus must be discarded</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">get_all_populations</span><span class="p">()[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">][:</span><span class="n">n_gens</span><span class="p">])</span>

        <span class="c1"># plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="s1">&#39;x--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_gens</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_gens</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\epsilon$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1">#xtl = ax.get_xticklabels()</span>
    <span class="c1">#ax.set_xticklabels(xtl, fontsize=12)</span>
    <span class="c1">#ax.set_yticklabels(ax.get_yticklabels(), fontsize=12)</span>

<span class="c1"># -------------------------------------</span>
<span class="c1"># Observed vs simulated stats and plots</span>
<span class="c1"># -------------------------------------</span>

<span class="k">def</span> <span class="nf">stats_obs_vs_sim</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">df_base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; T-tests within and across cohorts, observed and simulated traces  &quot;&quot;&quot;</span> 
    <span class="c1"># prep sim dataframe</span>
    <span class="n">df_sim</span> <span class="o">=</span> <span class="n">df_base</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subj&#39;</span><span class="p">,</span> <span class="s1">&#39;base_cohort&#39;</span><span class="p">],</span> <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Acc_OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;Acc_PFC&#39;</span><span class="p">,</span> <span class="s1">&#39;Acc_dPut&#39;</span><span class="p">,</span> <span class="s1">&#39;OFC_PFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut_OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut_PFC&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;pathway&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>
    <span class="n">df_sim</span> <span class="o">=</span> <span class="n">df_sim</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;base_cohort&#39;</span><span class="p">:</span><span class="s1">&#39;cohort&#39;</span><span class="p">})</span>

    <span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;observed&#39;</span>
    <span class="n">df_sim</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;simulated&#39;</span>
    <span class="n">df_fc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_data</span><span class="p">,</span> <span class="n">df_sim</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pathways</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Acc_OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;Acc_PFC&#39;</span><span class="p">,</span> <span class="s1">&#39;Acc_dPut&#39;</span><span class="p">,</span> <span class="s1">&#39;OFC_PFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut_OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut_PFC&#39;</span><span class="p">]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">pathway</span><span class="p">,</span><span class="nb">dict</span><span class="p">())</span> <span class="k">for</span> <span class="n">pathway</span> <span class="ow">in</span> <span class="n">pathways</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TWO-FACTOR ANOVA&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;================&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pathway</span> <span class="ow">in</span> <span class="n">df_fc</span><span class="o">.</span><span class="n">pathway</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pathway</span><span class="p">)</span>
        <span class="n">aov</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">anova</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_fc</span><span class="p">[</span><span class="n">df_fc</span><span class="o">.</span><span class="n">pathway</span><span class="o">==</span><span class="n">pathway</span><span class="p">],</span> <span class="n">between</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cohort&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="n">aov</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s1">&#39;aov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aov</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=============&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WELCH T-TESTS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=============&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pathway</span> <span class="ow">in</span> <span class="n">pathways</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pathway</span><span class="p">)</span>
        <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_fc</span><span class="p">[</span><span class="n">df_fc</span><span class="o">.</span><span class="n">pathway</span><span class="o">==</span><span class="n">pathway</span><span class="p">]</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;controls&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;observed&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;controls&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;simulated&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;con-con -- obs-sim   T=</span><span class="si">{:.2f}</span><span class="s2">   p=</span><span class="si">{:.4f}</span><span class="s2">   d=</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="s1">&#39;p-val&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="s1">&#39;cohen-d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;patients&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;observed&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;patients&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;simulated&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pat-pat -- obs-sim   T=</span><span class="si">{:.2f}</span><span class="s2">   p=</span><span class="si">{:.4f}</span><span class="s2">   d=</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;p-val&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="s1">&#39;cohen-d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cpo</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;controls&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;observed&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;patients&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;observed&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;con-pat -- obs-obs   T=</span><span class="si">{:.2f}</span><span class="s2">   p=</span><span class="si">{:.4f}</span><span class="s2">   d=</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpo</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cpo</span><span class="p">[</span><span class="s1">&#39;p-val&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cpo</span><span class="p">[</span><span class="s1">&#39;cohen-d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cps</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;controls&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;simulated&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;patients&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;simulated&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;con-pat -- sim-sim   T=</span><span class="si">{:.2f}</span><span class="s2">   p=</span><span class="si">{:.4f}</span><span class="s2">   d=</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cps</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cps</span><span class="p">[</span><span class="s1">&#39;p-val&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cps</span><span class="p">[</span><span class="s1">&#39;cohen-d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">os</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;observed&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">df_tmp</span><span class="p">[(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;simulated&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;obs-sim   T=</span><span class="si">{:.2f}</span><span class="s2">   p=</span><span class="si">{:.4f}</span><span class="s2">   d=</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cps</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cps</span><span class="p">[</span><span class="s1">&#39;p-val&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cps</span><span class="p">[</span><span class="s1">&#39;cohen-d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">stats</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s1">&#39;cc&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s1">&#39;pp&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s1">&#39;cpo&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s1">&#39;cps&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">cpo</span><span class="p">,</span> <span class="n">cps</span><span class="p">,</span> <span class="n">os</span>

    <span class="k">return</span> <span class="n">stats</span>

<div class="viewcode-block" id="plot_fc_sim_vs_data">
<a class="viewcode-back" href="../../../optimization.html#OCD_modeling.plot_fc_sim_vs_data">[docs]</a>
<span class="k">def</span> <span class="nf">plot_fc_sim_vs_data</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">df_base</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Plot functional connectivity (Pearson correlation) across the frontostriatal regions of interests </span>
<span class="sd">    in empirical and simulated data. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        df_data: pandas.DataFrame</span>
<span class="sd">            Empirical data extracted from fMRI in OCD subjects and healthy controls.</span>
<span class="sd">        df_base: pandas.DataFrame</span>
<span class="sd">            Simulated data using parameters infered from posterior distributions (either only OCD parameters  </span>
<span class="sd">            or only controls, no permutation to model virtual intervention).</span>
<span class="sd">        stats: dict</span>
<span class="sd">            (deprecated) Statistics within and between cohorts for both empirical and simulated data (deprecated </span>
<span class="sd">            since now stats are directly computed within plotting function).</span>
<span class="sd">        axes: list of matplotlib.Axes</span>
<span class="sd">            (optional) List of axes to plot data (if embedded in other figure, otherwise create new figure).</span>
<span class="sd">        args: argparse.Namespace</span>
<span class="sd">            (optional) Extra arguments (e.g. for saving, etc).</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    
    <span class="n">palette</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;controls&#39;</span><span class="p">:</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s1">&#39;patients&#39;</span><span class="p">:</span> <span class="s1">&#39;orange&#39;</span><span class="p">}</span>
    <span class="n">pathways</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Acc_OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;Acc_PFC&#39;</span><span class="p">,</span> <span class="s1">&#39;Acc_dPut&#39;</span><span class="p">,</span> <span class="s1">&#39;OFC_PFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut_OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut_PFC&#39;</span><span class="p">]</span>
    <span class="n">pathway_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAcc-OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;NAcc-LPFC&#39;</span><span class="p">,</span> <span class="s1">&#39;NAcc-dPut&#39;</span><span class="p">,</span> <span class="s1">&#39;OFC-LPFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut-OFC&#39;</span><span class="p">,</span> <span class="s1">&#39;dPut-LPFC&#39;</span><span class="p">]</span>
    <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_base</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">384</span><span class="p">]</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subj&#39;</span><span class="p">,</span> <span class="s1">&#39;base_cohort&#39;</span><span class="p">],</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">pathways</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;pathway&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>
    <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;base_cohort&#39;</span><span class="p">:</span><span class="s1">&#39;cohort&#39;</span><span class="p">})</span>

    <span class="c1"># select n random simulations for each cohort</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">50</span> 
    <span class="n">cons</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;controls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">subj</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">cons</span> <span class="o">=</span> <span class="n">cons</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cons</span><span class="p">))][:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">pats</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;patients&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">subj</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">pats</span> <span class="o">=</span> <span class="n">pats</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pats</span><span class="p">))][:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">subjs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">cons</span><span class="p">,</span> <span class="n">pats</span><span class="p">])</span>
    <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">subj</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subjs</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="n">axes</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">ax_data</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_sim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;figure.autolayout&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax_data</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">ax_sim</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">plot_stats_stars</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">y_level</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add stars on top of plots for stats significance &quot;&quot;&quot;</span> 
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pathway</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathways</span><span class="p">):</span>
            <span class="n">ttest</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">pathway</span><span class="o">==</span><span class="n">pathway</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;controls&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">]),</span> 
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">pathway</span><span class="o">==</span><span class="n">pathway</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">cohort</span><span class="o">==</span><span class="s1">&#39;patients&#39;</span><span class="p">)][</span><span class="s1">&#39;corr&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">ttest</span><span class="o">.</span><span class="n">pvalue</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.05</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">pathways</span><span class="p">)):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">y_level</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># DATA</span>
    <span class="c1"># ----</span>
    <span class="n">sbn</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;pathway&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;cohort&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">pathways</span><span class="p">,</span> 
                            <span class="n">ax</span><span class="o">=</span><span class="n">ax_data</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.8</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> 
                            <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">,</span> <span class="s1">&#39;patients&#39;</span><span class="p">])</span>
    <span class="c1">#plt.xticks(rotation=30, ha=&#39;right&#39;)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax_data</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_ha</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_rotation_mode</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span> <span class="c1">#&#39;anchor&#39;</span>
    <span class="n">ax_data</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_data</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_data</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plot_stats_stars</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_data</span><span class="p">,</span> <span class="n">y_level</span><span class="o">=</span><span class="mf">0.45</span><span class="p">)</span>
    <span class="n">ax_data</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
    <span class="n">ax_data</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="n">ax_data</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c1">#ax_data.set_xlabel(&#39;Pathway&#39;, fontsize=12)</span>
    <span class="n">ax_data</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">pathway_names</span><span class="p">)</span>


    <span class="c1"># SIMULATION</span>
    <span class="c1"># ----------</span>
    <span class="c1">#sbn.swarmplot(data=df_tmp, x=&#39;pathway&#39;, y=&#39;corr&#39;, hue=&#39;base_cohort&#39;, </span>
    <span class="c1">#                       ax=ax_sim, size=1.5, dodge=True, palette=palette, hue_order=[&#39;controls&#39;, &#39;patients&#39;])</span>
    <span class="n">sbn</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_tmp</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;pathway&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;cohort&#39;</span><span class="p">,</span> 
                           <span class="n">ax</span><span class="o">=</span><span class="n">ax_sim</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.8</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">hue_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">,</span> <span class="s1">&#39;patients&#39;</span><span class="p">])</span>
    <span class="c1">#plt.xticks(rotation=30, ha=&#39;right&#39;, rotation_mode=&#39;anchor&#39;)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax_sim</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_ha</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">set_rotation_mode</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span> <span class="c1">#&#39;anchor&#39;</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">plot_stats_stars</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_sim</span><span class="p">,</span> <span class="n">y_level</span><span class="o">=</span><span class="mf">0.45</span><span class="p">)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Simulated&#39;</span><span class="p">)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="c1">#ax_sim.set_xlabel(&#39;Pathway&#39;, fontsize=12)</span>
    <span class="n">ax_sim</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">pathway_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_figs</span><span class="p">:</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;fc_sim_vs_data&#39;</span><span class="o">+</span><span class="n">today</span><span class="o">+</span><span class="s1">&#39;.svg&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>

    
    

<div class="viewcode-block" id="plot_kdes">
<a class="viewcode-back" href="../../../optimization.html#OCD_modeling.plot_kdes">[docs]</a>
<span class="k">def</span> <span class="nf">plot_kdes</span><span class="p">(</span><span class="n">kdes</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">df_stats</span><span class="p">,</span> <span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;  Plot Kernel Density Estimates of posteriors &quot;&quot;&quot;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;mathtext.default&#39;</span><span class="p">:</span> <span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="s1">&#39;font.size&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;figure.constrained_layout.use&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span><span class="mi">5</span>
    <span class="n">row_offset</span><span class="p">,</span> <span class="n">col_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">3</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
    
    <span class="c1"># EPSILONS</span>
    <span class="c1">#ax = fig.add_subplot(gs[0:row_offset, 0:col_offset])</span>
    <span class="c1">#custom_plot_epsilons(histories, ax=ax)</span>
    
    <span class="c1"># KDES</span>
    <span class="n">ax_inds</span> <span class="o">=</span> <span class="n">get_ax_inds</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">row_offset</span><span class="p">,</span> <span class="n">col_offset</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="c1">#ax = plt.subplot(3,5,i+2)</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ax_inds</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;vals&#39;</span><span class="p">],</span> <span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;vals&#39;</span><span class="p">]])</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">13</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;vals&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;vals&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;pdf&#39;</span><span class="p">]),</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kdes</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;pdf&#39;</span><span class="p">]),</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xlabl</span> <span class="o">=</span> <span class="n">OCD_modeling</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">inference_analysis</span><span class="o">.</span><span class="n">format_labels</span><span class="p">([</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">col</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabl</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">rho$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1">#ax.xaxis.set_major_formatter(matplotlib.ticker.FormatStrFormatter(&#39;%.1f&#39;))</span>
        <span class="n">mn</span><span class="p">,</span><span class="n">mx</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mn</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">ttl</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">df_stats</span><span class="p">[</span><span class="n">df_stats</span><span class="o">.</span><span class="n">param</span><span class="o">==</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;p_u_bf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">:</span>
            <span class="n">ttl</span><span class="o">+=</span><span class="s1">&#39;*&#39;</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_stats</span><span class="p">[</span><span class="n">df_stats</span><span class="o">.</span><span class="n">param</span><span class="o">==</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.2</span><span class="p">:</span>
                <span class="n">ttl</span><span class="o">+=</span><span class="s1">&#39;*&#39;</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_stats</span><span class="p">[</span><span class="n">df_stats</span><span class="o">.</span><span class="n">param</span><span class="o">==</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">:</span>
                    <span class="n">ttl</span><span class="o">+=</span><span class="s1">&#39;*&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">ttl</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># FC</span>
    <span class="c1">#axes = {&#39;data&#39;: fig.add_subplot(gs[3:, 0:3]),</span>
    <span class="c1">#        &#39;sim&#39;: fig.add_subplot(gs[3:, 3:])}</span>
    <span class="c1">#plot_fc_sim_vs_data()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_figs</span><span class="p">:</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;kdes&#39;</span><span class="o">+</span><span class="n">today</span><span class="o">+</span><span class="s1">&#39;.svg&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>

    

<span class="c1"># ------------------------------------------ #</span>
<span class="c1"># Simulate at posterior distributions&#39; modes #</span>
<span class="c1"># ------------------------------------------ #</span>

<span class="k">def</span> <span class="nf">get_kde_peaks</span><span class="p">(</span><span class="n">kdes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Extract peaks of posterior distribution from kernel density estimates &quot;&quot;&quot;</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cohort</span> <span class="ow">in</span> <span class="n">kdes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">peaks</span><span class="p">[</span><span class="n">cohort</span><span class="p">]</span><span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">kdes</span><span class="p">[</span><span class="n">cohort</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">i_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">kdes</span><span class="p">[</span><span class="n">cohort</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s1">&#39;pdf&#39;</span><span class="p">])</span>
            <span class="n">X_max</span> <span class="o">=</span> <span class="n">kdes</span><span class="p">[</span><span class="n">cohort</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">][</span><span class="n">i_max</span><span class="p">]</span>
            <span class="n">peaks</span><span class="p">[</span><span class="n">cohort</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_max</span>
    <span class="k">return</span> <span class="n">peaks</span>


<span class="k">def</span> <span class="nf">simulate_posterior_modes</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Run simulations for posterior distribution&#39;s modes  &quot;&quot;&quot;</span>
    <span class="n">sim_outputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sim_args</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()</span>
        <span class="n">sim_args</span><span class="o">.</span><span class="n">n_sims</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_sims</span>
        <span class="n">sim_args</span><span class="o">.</span><span class="n">n_jobs</span><span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span>
        <span class="n">sim_args</span><span class="o">.</span><span class="n">t_tot</span> <span class="o">=</span> <span class="mi">15000</span>
        <span class="n">sim_args</span><span class="o">.</span><span class="n">t_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">]</span>
        <span class="n">sim_args</span><span class="o">.</span><span class="n">model_pars</span><span class="p">,</span> <span class="n">sim_args</span><span class="o">.</span><span class="n">sim_pars</span><span class="p">,</span> <span class="n">sim_args</span><span class="o">.</span><span class="n">control_pars</span><span class="p">,</span> <span class="n">sim_args</span><span class="o">.</span><span class="n">bold_pars</span> <span class="o">=</span> <span class="n">OCD_modeling</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">unpack_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">sim_objs</span> <span class="o">=</span> <span class="n">OCD_modeling</span><span class="o">.</span><span class="n">hpc</span><span class="o">.</span><span class="n">launch_simulations</span><span class="p">(</span><span class="n">sim_args</span><span class="p">)</span>
        <span class="n">sim_outputs</span><span class="p">[</span><span class="n">cohort</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_objs</span>
    <span class="k">return</span> <span class="n">sim_outputs</span>


<span class="k">def</span> <span class="nf">plot_epsilons_weights</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Combine the epsilons tolerances and the optimization weights &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">5</span>
    <span class="n">row_offset</span><span class="p">,</span> <span class="n">col_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="n">row_offset</span><span class="p">,:</span><span class="n">col_offset</span><span class="p">])</span>
    <span class="n">custom_plot_epsilons</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_gens</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">plot_weights</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">row_offset</span><span class="o">=</span><span class="n">row_offset</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">col_offset</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_figs</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilons_weights_log&#39;</span><span class="o">+</span><span class="n">today</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.svg&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilons_weights_log&#39;</span><span class="o">+</span><span class="n">today</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilons_weights_log&#39;</span><span class="o">+</span><span class="n">today</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<div class="viewcode-block" id="get_history_parser">
<a class="viewcode-back" href="../../../api/OCD_modeling.mcmc.html#OCD_modeling.get_history_parser">[docs]</a>
<span class="k">def</span> <span class="nf">get_history_parser</span><span class="p">():</span>
    <span class="s2">&quot; Script arguments when ran as main &quot;</span> 
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_jobs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of parallel processes launched&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_sims&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of simulations ran with the same parameters (e.g. to get distribution that can be campared to clinical observations)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--gens&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;generation of the optimization (list, must be same length as histories)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--histories&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;optimizations to analyse and compare&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--history_names&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">,</span> <span class="s1">&#39;patients&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;names given to each otpimization loaded&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--compute_kdes&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;compute KDEs of parameter estimations&#39;</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_kdes&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save KDEs&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_kdes_suffix&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">today</span><span class="p">(),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;identifier of the KDE in the saving folder&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_figs&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save figures&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_outputs&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save outputs&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_figs&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot figures&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_epsilons&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot optimization errors&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_weights&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot optimization weights for each gen&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_epsilons_weights&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot optimization errors&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_param_distrib&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot parameter distribution for each gen&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_kde_matrix&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot KDE matrix of optimization&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_stats&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;show statisics&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_kdes&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot KDEs of optimzed params&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_fc_sim_vs_data&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot FC of inference from optimization vs real data&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--simulate_posterior_modes&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;run simulations with at posterior distributions modes &#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">parser</span></div>



<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">get_history_parser</span><span class="p">()</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="n">histories</span> <span class="o">=</span> <span class="n">import_results</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_epsilons</span><span class="p">:</span>
        <span class="n">plot_epsilons</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_weights</span><span class="p">:</span>
        <span class="n">plot_weights</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_epsilons_weights</span><span class="p">:</span>
        <span class="n">plot_epsilons_weights</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_param_distrib</span><span class="p">:</span>
        <span class="n">plot_param_distrib</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_kde_matrix</span><span class="p">:</span>
        <span class="n">plot_kde_matrix</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_stats</span><span class="p">:</span>
        <span class="c1"># posterior distributions stats</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compute_kdes</span><span class="p">:</span>
        <span class="n">kdes</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">compute_kdes</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_kdes</span><span class="p">:</span>
        <span class="n">plot_kdes</span><span class="p">(</span><span class="n">kdes</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">df_stats</span><span class="p">,</span> <span class="n">histories</span><span class="o">=</span><span class="n">histories</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_fc_sim_vs_data</span><span class="p">:</span>
        <span class="c1"># load simulated and observed data</span>
        <span class="n">df_base</span> <span class="o">=</span> <span class="n">OCD_modeling</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">get_df_base</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1">#df_base = OCD_modeling.mcmc.fix_df_base(df_base)</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="n">OCD_modeling</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">load_df_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    
        <span class="c1"># observed vs simulated stats</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">stats_obs_vs_sim</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">df_base</span><span class="p">)</span>

        <span class="n">plot_fc_sim_vs_data</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">df_base</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">simulate_posterior_modes</span><span class="p">:</span>
        <span class="n">kde_peaks</span> <span class="o">=</span> <span class="n">get_kde_peaks</span><span class="p">(</span><span class="n">kdes</span><span class="p">)</span>
        <span class="n">sim_outputs</span> <span class="o">=</span> <span class="n">simulate_posterior_modes</span><span class="p">(</span><span class="n">kde_peaks</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_outputs</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s1">&#39;postprocessing&#39;</span><span class="p">,</span> <span class="s1">&#39;sims_posterior_modes&#39;</span><span class="o">+</span><span class="n">today</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sim_outputs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Sebastien Naze.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>